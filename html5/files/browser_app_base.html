<div id="playground" style="width: 100%; height: 100%;;" class="calcitExtremeBackground"></div>
<script>
	//Service worker registration
	//Idea from https://developers.google.com/web/fundamentals/primers/service-workers/
	window.addEventListener('load', function() {
		navigator.serviceWorker.register('/serviceWorker.js').then(function(registration) {
			// Registration was successful
			console.log('ServiceWorker registration successful with scope: ', registration.scope);
			
			//Cache the current site
			caches.open('my-site-cache-v2').then(cache => {
				cache.add(window.location.href).then(() => {
					console.log("The main site was cached! " + window.location.href)
				})
			});
			
			//Attempt to establish a connection to the network - let through by the service worker in any case
			fetch("/nocache/fetched.txt").then(response => {
				console.log("A connection to the server was established - code " + response.status);
			})
		}, function(err) {
			// registration failed :(
			console.log('ServiceWorker registration failed: ', err);
		});
	})
	
	//Timeout
	var timeoutSince = parseInt(GLang.eval("storageLoadString: 'kalzit.timeoutSince'").value);
	var timeoutActive = false;
	var timeoutMinutes = parseInt(GLang.eval("storageLoadString: 'kalzit.timeoutMinutes'").value);
	
	if (timeoutSince) {
		//Timeout is set - check what to do now
		var diff = Date.now() - timeoutSince;
		if(diff < 1000 * 60 * 20) {
			//Twenty minutes are not up yet - do not allow using the app
			timeoutActive = true;
			GLang.eval("'kalzit.timeoutMinutes' storageSaveString 0");
		} else {
			//Timeout is over - reset minute count (allows 30 minutes of usage)
			Timeout.startTimer(timeoutMinutes);
		}
	} else {
		Timeout.startTimer(timeoutMinutes);	
	}
	
	if (!timeoutActive){
		$app$
	} else alert("Your app timeout is currently active - you can use the Kalzit apps again in 20 minutes (or less)")
</script>