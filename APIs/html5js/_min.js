this.appUrl=window.location.href;this.dynamicAppUrl=function(){return window.location.href};(function(){GLang.defaultRuntimeEnvironment.setInnerVariable("dom_parse",{value:GLang.arrayFun(function(env,args){var dom=(new DOMParser).parseFromString(args[0].value,"text/xml");return{value:dom}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_tags",{value:GLang.arrayFun(function(env,args){var dom=args[1].value;var tag=args[0].value;var array=[];var elements=dom.getElementsByTagName(tag);for(var i=0;i<elements.length;i++){array.push({value:elements[i]})}return{value:array}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_attribute",{value:GLang.arrayFun(function(env,args){var element=args[1].value;var attrib=args[0].value;return{value:element.getAttribute(attrib)||""}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_inner_text",{value:GLang.arrayFun(function(env,args){return{value:args[0].value.innerHTML}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_inner",{value:GLang.arrayFun(function(env,args){var elements=args[0].value.childNodes;var newArray=[];for(var i=0;i<elements.length;i++){newArray.push({value:elements[i]})}return{value:elements}})})})();(function(thiz){var load=KNI.hasSynchronousLoader()?KNI.getSynchronousLoader():null;var loadAsyncKNI=KNI.hasAsynchronousLoader()?KNI.getAsynchronousLoader():null;console.log("syncLoadApi: "+(load?"KNI":"GLang.packageManager")+" is used for loading");console.log("asyncLoadApi: "+(loadAsyncKNI?"KNI":"Browser implementation")+" is used for loading asynchronously");function headersValuesToStringsArray(_headers){if(_headers){var headerArray=[];for(var i=0;i<_headers.length;i++){headerArray[i]=[_headers[i].value[0].value,_headers[i].value[1].value]}return headerArray}}thiz.loadGlobal=load?function(u,_hs){return load.global(u,GLang.headersArrayToJson(headersValuesToStringsArray(_hs)))}:function(url,_headers){return GLang.packageManager.loadUrl("/api/loadUrl?query="+encodeURIComponent(url+""),headersValuesToStringsArray(_headers))};thiz.loadLocal=load?function(u,_hs){return load.local(u,GLang.headersArrayToJson(headersValuesToStringsArray(_hs)))}:function(url,_headers){return GLang.packageManager.loadUrl(url,headersValuesToStringsArray(_headers))};function makeCallback(callbackValue,env){return function(value){GLang.callObject(callbackValue,env,[value])}}var loadAsync=function(callbackValue,path,env){var callback=makeCallback(callbackValue,env);var xhr=new XMLHttpRequest;xhr.open("GET",path,true);xhr.onload=function(e){if(xhr.readyState===4){if(xhr.status===200){callback(GLang.stringValue(xhr.responseText))}else{callback(GLang.voidValue)}}};xhr.onerror=function(e){callback(GLang.voidValue)};xhr.send(null)};GLang.defaultRuntimeEnvironment.setInnerVariable("load_local_async",{value:GLang.arrayFun(function(env,args){loadAsyncKNI?loadAsyncKNI.localAsync(makeCallback(args[0],env),args[1].value):loadAsync(args[0],args[1].value,env);return GLang.voidValue})});GLang.defaultRuntimeEnvironment.setInnerVariable("load_global_async",{value:GLang.arrayFun(function(env,args){loadAsyncKNI?loadAsyncKNI.globalAsync(makeCallback(args[0],env),args[1].value):loadAsync(args[0],"/api/loadUrl?query="+encodeURIComponent(args[1].value),env);return GLang.voidValue})})})(this);this.popupHtml=function(html){window.open("","","").document.body.innerHTML=html};GLang.defaultRuntimeEnvironment.setInnerVariable("popup_values",{value:function(env,args){var b=window.open("","","").document.body;var array=args[0].value;if(!(array instanceof Array)){array=[args[0]]}for(var i=0;i<array.length;i++){b.appendChild(GLang.displayValue(array[i]))}return{value:0,display:"none"}}});this.popupMessage=function(textMessage){alert(textMessage)};this.popupQuestion=function(question){return prompt(question)};this.redirect=function(url){window.location=url};(function(){function repeatAsync(env,args){var repeat=true;var isRunning=true;function thisGetsRepeated(){GLang.callObject(args[1],env,[]);if(repeat){setTimeout(thisGetsRepeated,args[0].value)}else{isRunning=false}}thisGetsRepeated();return GLang.wrapJsToValue({exit:function(){repeat=false},isRunning:function(){return isRunning}})}GLang.defaultRuntimeEnvironment.setInnerVariable("repeatAsync",{value:repeatAsync,display:"function"})})();(function(thiz){var nativeStorage=KNI.hasStorage()?KNI.getStorage():null;function withLocalStorage(onSuccess,onError){try{if(localStorage){onSuccess(localStorage)}else{throw new Error("Does not work")}}catch(e){if(onError)onError(e)}}var native_loadString=nativeStorage?function(key){return nativeStorage.loadString(key)||null}:function(name){var result;withLocalStorage(function(storage){result=storage.getItem(name)});return result};var native_saveString=nativeStorage?function(key,value){nativeStorage.saveString(key,value)}:function(name,value){withLocalStorage(function(storage){storage.setItem(name,value)})};function getServerCookies(){var token=native_loadString("calcitUserToken");if(!token)return;try{return JSON.parse(GLang.packageManager.loadUrl("/api/cookieJson",[["kalzit-user-token",token]]))}catch(e){}}var serverCookies={};function pullAllCookies(){var response=serverCookies=getServerCookies();serverCookies=serverCookies||{};if(response){for(var key in response){var value=response[key];if("string"===typeof value)native_saveString(key,value)}}}var toPush=[];var deleted=[];function pushCookie(name){if(deleted.includes(name))return;var xhr=new XMLHttpRequest;xhr.open("GET","/api/pushCookie");xhr.setRequestHeader("kalzit-cookie-name",name);xhr.setRequestHeader("kalzit-cookie-value",encodeURIComponent(native_loadString(name)));xhr.setRequestHeader("kalzit-user-token",native_loadString("calcitUserToken"));xhr.onload=function(){if(this.status>=200&&this.status<300){}else{toPush.push(name)}};xhr.onerror=function(){toPush.push(name)};xhr.send()}function pushNewCookies(){if(!native_loadString("calcitUserToken"))return;while(toPush.length){pushCookie(toPush.pop())}}function pushAllCookies(){if(!native_loadString("calcitUserToken"))return;var keyList=thiz.storageListKeys();console.log("Trying to push these keys: "+JSON.stringify(keyList));for(var i=0;i<keyList.length;i++){var key=keyList[i];if(serverCookies[key]!==native_loadString(key))pushCookie(key)}}function setCookie(name,value){native_saveString(name,value);toPush.push(name)}function startCookieRefreshLoop(){setInterval(pushNewCookies,1*1e3);setTimeout(pushAllCookies,15*1e3)}function deleteCookie(name){console.log("Trying to delete cookie "+name);deleted.push(name);GLang.packageManager.loadUrl("/api/deleteCookie?cookie="+encodeURIComponent(name));withLocalStorage(function(storage){storage.removeItem(name)})}thiz.storageSaveString=setCookie;thiz.storageRemove=nativeStorage?function(k){nativeStorage.remove(k)}:deleteCookie;thiz.storageLoadString=native_loadString;thiz.storageListKeys=nativeStorage?function(){return JSON.parse(nativeStorage.listKeysAsJson())}:function(){var list=[];withLocalStorage(function(storage){var length=storage.getLength?storage.getLength():storage.length;for(var i=0;i<length;i++){list.push(storage.key(i))}});console.log(list);return list};var token=native_loadString("calcitUserToken");console.log("calcitUserToken is "+token);if(token===undefined){alert("Your browser does not support or allow storing data locally. The functionality of this app might be limited by that.")}else if(token!==null){token=""+token;if(!token.match(new RegExp("[a-f0-9]{8}\\-[a-f0-9]{4}\\-[a-f0-9]{4}\\-[a-f0-9]{4}\\-[a-f0-9]{12}"))){alert("The account you are logged in with seems invalid: ("+token+"). You are logged out now and your local data are deleted to try to make the app work again. Please try to  login again. If you see an error message which does not go away after reloading or if you see this message again, please ask for help.");thiz.storageRemove("calcitUserToken");withLocalStorage(function(storage){storage.clear()});location.reload()}else{console.log("User token seems valid")}}if(native_loadString("calcitUserToken")){if(nativeStorage&&nativeStorage.wantsFullPush()){pushAllCookies()}pullAllCookies();startCookieRefreshLoop()}})(this);this.getUserLanguage=function(){return navigator.language||navigator.userLanguage};