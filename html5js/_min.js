this.appUrl=window.location.href;this.dynamicAppUrl=function(){return window.location.href};(function(){GLang.defaultRuntimeEnvironment.setInnerVariable("dom_parse",{value:GLang.arrayFun(function(env,args){var dom=(new DOMParser).parseFromString(args[0].value,"text/xml");return{value:dom}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_tags",{value:GLang.arrayFun(function(env,args){var dom=args[1].value;var tag=args[0].value;var array=[];var elements=dom.getElementsByTagName(tag);for(var i=0;i<elements.length;i++){array.push({value:elements[i]})}return{value:array}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_attribute",{value:GLang.arrayFun(function(env,args){var element=args[1].value;var attrib=args[0].value;return{value:element.getAttribute(attrib)||""}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_inner_text",{value:GLang.arrayFun(function(env,args){return{value:args[0].value.innerHTML}})});GLang.defaultRuntimeEnvironment.setInnerVariable("dom_inner",{value:GLang.arrayFun(function(env,args){var elements=args[0].value.childNodes;var newArray=[];for(var i=0;i<elements.length;i++){newArray.push({value:elements[i]})}return{value:elements}})})})();this.loadGlobal=function(url,_headers){var headerArray;if(_headers){headerArray=[];for(var i=0;i<_headers.length;i++){headerArray[i]=[_headers[i].value[0].value,_headers[i].value[1].value]}}return GLang.packageManager.loadUrl("/api/loadUrl?query="+encodeURIComponent(url+""),headerArray)};this.loadLocal=function(url,_headers){var headerArray;if(_headers){headerArray=[];for(var i=0;i<_headers.length;i++){headerArray[i]=[_headers[i].value[0].value,_headers[i].value[1].value]}}return GLang.packageManager.loadUrl(url,headerArray)};(function(){function loadAsync(callbackValue,path,env){var callback=function(value){GLang.callObject(callbackValue,env,[value])};var xhr=new XMLHttpRequest;xhr.open("GET",path,true);xhr.onload=function(e){if(xhr.readyState===4){if(xhr.status===200){callback(GLang.stringValue(xhr.responseText))}else{callback(GLang.voidValue)}}};xhr.onerror=function(e){callback(GLang.voidValue)};xhr.send(null)}GLang.defaultRuntimeEnvironment.setInnerVariable("load_local_async",{value:GLang.arrayFun(function(env,args){loadAsync(args[0],args[1].value,env);return{value:0}})});GLang.defaultRuntimeEnvironment.setInnerVariable("load_global_async",{value:GLang.arrayFun(function(env,args){loadAsync(args[0],"/api/loadUrl?query="+encodeURIComponent(GLang.displayValue(args[1]).innerHTML),env);return{value:0}})})})();this.popupHtml=function(html){window.open("","","").document.body.innerHTML=html};this.popupUrl=function(url){window.open(url,"","")};GLang.defaultRuntimeEnvironment.setInnerVariable("popup_values",{value:function(env,args){var b=window.open("","","").document.body;var array=args[0].value;if(!(array instanceof Array)){array=[args[0]]}for(var i=0;i<array.length;i++){b.appendChild(GLang.displayValue(array[i]))}return{value:0,display:"none"}}});this.popupMessage=function(textMessage){alert(textMessage)};this.popupQuestion=function(question){return prompt(question)};this.redirect=function(url){window.location=url};(function(){function repeatAsync(env,args){var repeat=true;var isRunning=true;function thisGetsRepeated(){GLang.callObject(args[1],env,[]);if(repeat){setTimeout(thisGetsRepeated,args[0].value)}else{isRunning=false}}thisGetsRepeated();return GLang.wrapJsToValue({exit:function(){repeat=false},isRunning:function(){return isRunning}})}GLang.defaultRuntimeEnvironment.setInnerVariable("repeatAsync",{value:repeatAsync,display:"function"})})();(function(thiz){function getVoiceObject(voiceName){for(var i=0;i<speechSynthesis.getVoices().length;i++){if(speechSynthesis.getVoices()[i].name===voiceName){return speechSynthesis.getVoices()[i]}}}thiz.speechSay=function(text,voice){var ssu=new SpeechSynthesisUtterance(text);ssu.voice=getVoiceObject(voice)||ssu.voice;speechSynthesis.speak(ssu);return text};thiz.speechGetVoicesByLanguage=function(language){var list=[];for(var i=0;i<speechSynthesis.getVoices().length;i++){if(speechSynthesis.getVoices()[i].lang.startsWith(language)){list.push(speechSynthesis.getVoices()[i].name)}}return list};thiz.speechGetVoices=function(){var list=[];for(var i=0;i<speechSynthesis.getVoices().length;i++){list.push(speechSynthesis.getVoices()[i].name)}return list}})(this);(function(thiz){function withLocalStorage(onSuccess,onError){try{if(localStorage){onSuccess(localStorage)}else{throw new Error("Does not work")}}catch(e){if(onError)onError(e)}}function deleteOnlyCookie(name){document.cookie=name+"=INVALID; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/"}deleteOnlyCookie("calcitUserToken");var pending=[];var pulled=[];function pullCookie(name){withLocalStorage(function(storage){if(!storage.getItem("calcitUserToken"))return;if(pulled.includes(name))return;var response=GLang.packageManager.loadUrl("/api/pullCookie",[["kalzit-user-token",storage.getItem("calcitUserToken")],["kalzit-cookie-name",name]]).split("\n");if(response[0]==="0"){setCookie(name,decodeURIComponent(response[1]))}pulled.push(name)})}var toPush=[];var deleted=[];function pushCookie(name){if(deleted.includes(name))return;var xhr=new XMLHttpRequest;xhr.open("GET","/api/pushCookie");xhr.setRequestHeader("kalzit-cookie-name",name);xhr.setRequestHeader("kalzit-cookie-value",encodeURIComponent(thiz.storageLoadString(name)));xhr.setRequestHeader("kalzit-user-token",thiz.storageLoadString("calcitUserToken"));xhr.onload=function(){if(this.status>=200&&this.status<300){}else{toPush.push(name)}};xhr.onerror=function(){toPush.push(name)};xhr.send()}function pullCookies(){if(!thiz.storageLoadString("calcitUserToken"))return;var list=thiz.storageListKeys();for(var i=0;i<list.length;i++){pullCookie(list[i])}}function pushNewCookies(){if(!thiz.storageLoadString("calcitUserToken"))return;while(toPush.length){pushCookie(toPush.pop())}}function pushAllCookies(){if(!thiz.storageLoadString("calcitUserToken"))return;withLocalStorage(function(storage){for(var i=0;i<storage.length;i++){pushCookie(storage.key(i))}})}function queque(f){if(cookiesRejected)return;if(!notificationShown){var defaultCookieBanner=GLang.defaultRuntimeEnvironment.resolveName("defaultCookieBanner");GLang.callObject(GLang.defaultRuntimeEnvironment.resolveName("print"),GLang.defaultRuntimeEnvironment,[defaultCookieBanner]);notificationShown=true}pending.push(f)}function setCookie(name,value){withLocalStorage(function(storage){storage.setItem(name,value);deleteOnlyCookie(name);toPush.push(name)})}function startCookieRefreshLoop(){setInterval(pushNewCookies,1*1e3);setTimeout(pushAllCookies,15*1e3)}function deleteCookie(name){console.log("Trying to delete cookie "+name);deleted.push(name);deleteOnlyCookie(name);GLang.packageManager.loadUrl("/api/deleteCookie?cookie="+encodeURIComponent(name));withLocalStorage(function(storage){storage.removeItem(name)})}thiz.storageSaveString=setCookie;thiz.storageRemove=deleteCookie;thiz.storageLoadString=function(name){var result;pullCookie(name);withLocalStorage(function(storage){result=storage.getItem(name);deleteOnlyCookie(name)});return result};thiz.storageListKeys=function(){var list=[];withLocalStorage(function(storage){for(var i=0;i<storage.length;i++){list.push(storage.key(i))}});console.log(list);return list};var token=thiz.storageLoadString("calcitUserToken");console.log("calcitUserToken is "+token);if(token!==null){token=""+token;if(!token.match(new RegExp("[a-f0-9]{8}\\-[a-f0-9]{4}\\-[a-f0-9]{4}\\-[a-f0-9]{4}\\-[a-f0-9]{12}"))){alert("The account you are logged in with seems invalid: ("+token+"). You are logged out now and your local data are deleted to try to make the app work again. Please try to  login again. If you see an error message which does not go away after reloading or if you see this message again, please ask for help.");thiz.storageRemove("calcitUserToken");withLocalStorage(function(storage){for(var i=storage.length-1;i>=0;i--){storage.removeItem(storage.key(i))}});location.reload()}else{console.log("User token seems valid")}}pullCookies();startCookieRefreshLoop()})(this);(function(){var queue=[];var apiLoaded=false;var apiBooted=false;function runWithTwitchApi(fun){try{if(apiLoaded){fun()}else{queue.push(fun);if(!apiBooted){var scriptTag=document.createElement("script");scriptTag.src="https://player.twitch.tv/js/embed/v1.js";scriptTag.onload=function(){apiLoaded=true;while(queue.length)queue.pop()()};document.head.appendChild(scriptTag);apiBooted=true}}}catch(e){console.error("Dang, this might be why the twitch player does not work:");console.error(e)}}function uiTwitchChannelPlayer(channel,playerCallback){var player=document.createElement("div");runWithTwitchApi(function(){playerCallback(new Twitch.Player(player,{channel:channel,width:"100%",height:"100%"}))});return{display:"dom",value:player}}function uiTwitchVideoPlayer(video,playerCallback){var player=document.createElement("div");runWithTwitchApi(function(){playerCallback(new Twitch.Player(player,{video:video,width:"100%",height:"100%"}))});return{display:"dom",value:player}}function uiTwitchCollectionPlayer(collection,playerCallback){var player=document.createElement("div");runWithTwitchApi(function(){playerCallback(new Twitch.Player(player,{collection:collection,width:"100%",height:"100%"}))});return{display:"dom",value:player}}function playerValue(player){var onEnd=function(){};player.addEventListener(Twitch.Player.ENDED,function(state){onEnd()});var onProgress=function(time){};var lastTime=null;setInterval(function(){var newTime=player.getCurrentTime();if(lastTime!==newTime){onProgress(lastTime=newTime)}},100);var controller={value:[{value:[{value:"play"},{value:function(env,args){player.play();return GLang.voidValue},display:"function"}]},{value:[{value:"pause"},{value:function(env,args){player.pause();return GLang.voidValue},display:"function"}]},{value:[{value:"getDuration"},{value:function(env,args){return{value:player.getDuration()}},display:"function"}]},{value:[{value:"setTime"},{value:function(env,args){player.seek(parseInt(args[0].value+""));return GLang.voidValue},display:"function"}]},{value:[{value:"setVolume"},{value:function(env,args){player.setVolume(parseFloat(args[0].value+""));return GLang.voidValue},display:"function"}]},{value:[{value:"getVolume"},{value:function(env,args){return{value:player.getVolume()}},display:"function"}]},{value:[{value:"setOnEnd"},{value:function(env,args){onEnd=function(){GLang.callObject(args[0],env,[controller])};return GLang.voidValue},display:"function"}]},{value:[{value:"getProgress"},{value:function(env,args){return{value:player.getCurrentTime()}},display:"function"}]},{value:[{value:"setOnProgress"},{value:function(env,args){onProgress=function(time){GLang.callObject(args[0],env,[{value:time},controller])};return GLang.voidValue},display:"function"}]}]};return controller}GLang.defaultRuntimeEnvironment.setInnerVariable("uiTwitchChannelPlayer",{value:function(env,args){return uiTwitchChannelPlayer(args[0].value,function(player){GLang.callObject(args.length>=2?args[1]:{value:""},env,[playerValue(player)])})}});GLang.defaultRuntimeEnvironment.setInnerVariable("uiTwitchVideoPlayer",{value:function(env,args){return uiTwitchVideoPlayer(args[0].value,function(player){GLang.callObject(args.length>=2?args[1]:{value:""},env,[playerValue(player)])})}});GLang.defaultRuntimeEnvironment.setInnerVariable("uiTwitchCollectionPlayer",{value:function(env,args){return uiTwitchCollectionPlayer(args[0].value,function(player){GLang.callObject(args.length>=2?args[1]:{value:""},env,[playerValue(player)])})}})})();this.getUserLanguage=function(){return navigator.language||navigator.userLanguage};(function(){var queue=[];var apiLoaded=false;var apiBooted=true;function runWithVimeoApi(fun){try{if(apiLoaded){fun()}else{queue.push(fun);if(!apiBooted){var scriptTag=document.createElement("script");scriptTag.src="https://player.vimeo.com/api/player.js";scriptTag.onload=function(){apiLoaded=true;while(queue.length)queue.pop()()};document.head.appendChild(scriptTag);apiBooted=true}}}catch(e){console.error(e)}}function uiVimeoPlayer(video,playerCallback){var frame=document.createElement("iframe");frame.src="https://player.vimeo.com/video/"+video;frame.setAttribute("frameborder",0);runWithVimeoApi(function(){playerCallback(new Vimeo.Player(frame))});return{display:"dom",value:frame}}function playerValue(player){var onEnd=function(){};player.on("ended",function(data){onEnd()});var onProgress=function(time){};var lastTime=null;setInterval(function(){var newTime=player.getCurrentTime();if(lastTime!==newTime){onProgress(lastTime=newTime)}},100);var controller={value:[{value:[{value:"play"},{value:function(env,args){player.play();return GLang.voidValue},display:"function"}]},{value:[{value:"pause"},{value:function(env,args){player.pause();return GLang.voidValue},display:"function"}]},{value:[{value:"getDuration"},{value:function(env,args){return{value:player.getDuration()}},display:"function"}]},{value:[{value:"setTime"},{value:function(env,args){player.seek(parseInt(args[0].value+""));return GLang.voidValue},display:"function"}]},{value:[{value:"setVolume"},{value:function(env,args){player.setVolume(parseFloat(args[0].value+""));return GLang.voidValue},display:"function"}]},{value:[{value:"getVolume"},{value:function(env,args){return{value:player.getVolume()}},display:"function"}]},{value:[{value:"setOnEnd"},{value:function(env,args){onEnd=function(){GLang.callObject(args[0],env,[controller])};return GLang.voidValue},display:"function"}]},{value:[{value:"getProgress"},{value:function(env,args){return{value:player.getCurrentTime()}},display:"function"}]},{value:[{value:"setOnProgress"},{value:function(env,args){onProgress=function(time){GLang.callObject(args[0],env,[{value:time},controller])};return GLang.voidValue},display:"function"}]}]};return controller}GLang.defaultRuntimeEnvironment.setInnerVariable("uiVimeoPlayer",{value:function(env,args){return uiVimeoPlayer(args[0].value,function(player){GLang.callObject(args.length>=2?args[1]:{value:""},env,[playerValue(player)])})}})})();(function(){var queue=[];var apiLoaded=false;var apiBooted=false;window.onYouTubePlayerAPIReady=function(){apiLoaded=true;while(queue.length){queue.pop()()}};function runWithYtApi(fun){if(apiLoaded){fun()}else{queue.push(fun);if(!apiBooted){var tag=document.createElement("script");tag.src="https://www.youtube.com/player_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);apiBooted=true}}}function uiYoutubePlayer(id,playerCallback){var player=document.createElement("div");runWithYtApi(function(){playerCallback(new YT.Player(player,{videoId:id}))});return{display:"dom",value:player}}function playerValue(player){var onEnd=function(){};player.addEventListener("onStateChange",function(state){switch(state.data){case YT.PlayerState.ENDED:onEnd();break}});var onProgress=function(time){};var lastTime=null;setInterval(function(){var newTime=player.getCurrentTime();if(lastTime!==newTime){onProgress(lastTime=newTime)}},100);var controller={value:[{value:[{value:"play"},{value:function(env,args){player.playVideo();return GLang.voidValue},display:"function"}]},{value:[{value:"pause"},{value:function(env,args){player.pauseVideo();return GLang.voidValue},display:"function"}]},{value:[{value:"getDuration"},{value:function(env,args){return{value:player.getDuration()}},display:"function"}]},{value:[{value:"setTime"},{value:function(env,args){player.seekTo(parseInt(args[0].value+""));return GLang.voidValue},display:"function"}]},{value:[{value:"setVolume"},{value:function(env,args){player.setVolume(parseFloat(args[0].value+"")*100);return GLang.voidValue},display:"function"}]},{value:[{value:"getVolume"},{value:function(env,args){return{value:player.getVolume()/100}},display:"function"}]},{value:[{value:"setOnEnd"},{value:function(env,args){onEnd=function(){GLang.callObject(args[0],env,[controller])};return GLang.voidValue},display:"function"}]},{value:[{value:"getProgress"},{value:function(env,args){return{value:player.getCurrentTime()}},display:"function"}]},{value:[{value:"setOnProgress"},{value:function(env,args){onProgress=function(time){GLang.callObject(args[0],env,[{value:time},controller])};return GLang.voidValue},display:"function"}]}]};return controller}GLang.defaultRuntimeEnvironment.setInnerVariable("uiNativeYoutubePlayer",{value:function(env,args){return uiYoutubePlayer(args[0].value,function(player){console.log(player);GLang.callObject(args.length>=2?args[1]:{value:""},env,[playerValue(player)])})}})})();